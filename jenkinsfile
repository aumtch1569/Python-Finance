pipeline {
    agent any

    environment {
        // สร้าง Timestamp สำหรับ Backup
        BACKUP_TIMESTAMP = sh(script: "date +'%Y%m%d_%H%M%S'", returnStdout: true).trim()
        
    }

    stages {
        stage('Backup Code') {
            steps {
                script {
                    echo "Starting Backup to Folder: ${BACKUP_TIMESTAMP}"
                    sh """
                        mkdir -p /opt/TAX_backup/${BACKUP_TIMESTAMP}
                        rsync -a --exclude='.git' --exclude='node_modules' ./ /opt/TAX_backup/${BACKUP_TIMESTAMP}/
                    """
                }
            }
        }

        stage('Pull Code') {
            steps {
                cleanWs()
                checkout scm
                sh "ls -la"
                echo "Code pulled and workspace cleaned."
            }
        }

        stage('Build and Deploy Docker') {
            steps {
                script {
                    def rawBranch = env.BRANCH_NAME ?: env.GIT_BRANCH ?: 'main'
                    def branchName = rawBranch.replace('origin/', '') 
                    echo "Building for branch: ${branchName}"

                    // ลบหรือ Comment ปีกกาที่เคยครอบ withCredentials ออกให้หมด
                    sh """
                        chmod +x deployment.sh
                        ./deployment.sh "${branchName}" "${env.GIT_URL}" "${env.BACKUP_TIMESTAMP}"
                    """
                }
            }
        }
    }

    post {
        success { echo 'Deployment Successful!' }
        failure { echo 'Deployment Failed. Please check the logs.' }
    }
}
